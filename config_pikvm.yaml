# PyLiRP Configuration for PiKVM (Read-Only Filesystem)
# This configuration disables file logging to work with read-only filesystems

serial:
  port: /dev/ttyGS0  # PiKVM USB gadget serial port
  baudrate: 115200
  flow_control: hardware  # none/hardware/software
  timeout: 5.0
  write_timeout: 2.0

network:
  local_ip: 10.0.0.1
  remote_ip: 10.0.0.2
  mtu: 1500
  netmask: 255.255.255.0

ppp:
  lcp_echo_interval: 30
  lcp_echo_failure_threshold: 3
  max_configure_requests: 10
  restart_timeout: 3
  negotiate_magic: true
  negotiate_mru: true
  negotiate_compression: true
  default_mru: 1500
  magic_number: null  # Auto-generated if null

tcp:
  # TCP Stack Configuration
  initial_window_size: 8192
  max_window_size: 65535
  mss: 1460
  retransmission_timeout_min: 200  # milliseconds
  retransmission_timeout_max: 60000  # milliseconds
  max_retransmissions: 5
  keepalive_interval: 7200  # seconds
  keepalive_probes: 9
  keepalive_probe_interval: 75  # seconds
  time_wait_timeout: 120  # seconds
  
  # Congestion Control
  congestion_algorithm: reno  # reno/cubic
  initial_cwnd: 10  # segments
  slow_start_threshold: 65535
  duplicate_ack_threshold: 3

services:
  # Port mapping: PPP client port -> local service
  22: 
    host: 127.0.0.1
    port: 22
    name: SSH
    enabled: true
    max_connections: 10
    connection_timeout: 300
  
  80:
    host: 127.0.0.1
    port: 80
    name: HTTP
    enabled: true
    max_connections: 50
    connection_timeout: 60
    
  443:
    host: 127.0.0.1
    port: 443
    name: HTTPS
    enabled: true
    max_connections: 50
    connection_timeout: 120

proxy:
  type: none  # none/socks5/http
  host: 127.0.0.1
  port: 1080
  username: null
  password: null
  connection_timeout: 10
  enabled: false

security:
  # Access Control
  allowed_ports: [22, 80, 443, 3000, 5000, 8000, 8080]
  blocked_ips: []
  rate_limiting:
    enabled: true
    connections_per_second: 10
    burst_size: 20
    window_size: 60  # seconds
  
  connection_limits:
    global_max_connections: 200
    per_service_max: 50
    per_ip_max: 20
  
  # Security Logging
  log_security_events: true
  log_rejected_connections: true
  log_rate_limit_violations: true

logging:
  level: INFO  # DEBUG/INFO/WARNING/ERROR/CRITICAL
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  
  # File Logging DISABLED for read-only filesystems
  file:
    enabled: false  # CRITICAL: Disabled for PiKVM read-only filesystem
    path: /dev/null  # Dummy path, not used
    max_size: 10MB
    rotate_count: 5
  
  # Console Logging - will go to systemd journal
  console:
    enabled: true
    color: false  # Disable colors for systemd journal
  
  # Component-specific logging levels
  components:
    ppp: INFO
    tcp: INFO
    serial: INFO
    proxy: INFO
    security: INFO
    metrics: INFO

monitoring:
  # Metrics Collection
  enable_metrics: true
  metrics_port: 9090  # Prometheus metrics endpoint
  metrics_path: /metrics
  
  # Health Checks
  health_check:
    enabled: true
    port: 9091
    path: /health
    
  # Packet Capture DISABLED for read-only filesystems
  packet_capture:
    enabled: false  # CRITICAL: Disabled for PiKVM read-only filesystem
    pcap_file: /dev/null  # Dummy path, not used
    max_file_size: 100MB
    rotate_files: false
    
  # Performance Monitoring
  performance:
    track_connection_stats: true
    track_bandwidth: true
    track_latency: true
    stats_interval: 30  # seconds

error_recovery:
  # Connection Recovery
  auto_reconnect_serial: true
  serial_reconnect_delay: 5  # seconds
  max_serial_reconnect_attempts: 10
  
  # Service Recovery
  service_retry_delay: 1  # seconds
  max_service_retry_attempts: 3
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    recovery_timeout: 60  # seconds
    half_open_max_calls: 3
  
  # Protocol Recovery
  ppp_negotiation_timeout: 30  # seconds
  tcp_connection_cleanup_interval: 60  # seconds
  orphaned_connection_timeout: 300  # seconds

development:
  # Development and Testing Options
  debug_packets: false
  simulate_packet_loss: false
  packet_loss_rate: 0.0  # 0.0 to 1.0
  simulate_latency: false
  artificial_latency_ms: 0
  
  # Mock Services
  mock_services:
    enabled: false
    echo_port: 7777
    discard_port: 7778

# PiKVM NOTES:
# 1. File logging is DISABLED to prevent read-only filesystem errors
# 2. All logging goes to systemd journal - view with: journalctl -u pyslirp -f
# 3. Packet capture is DISABLED - use tcpdump on interfaces if needed
# 4. Metrics are still available at http://localhost:9090/metrics
# 5. To enable logging to tmpfs, mount /var/log/pyslirp as tmpfs first